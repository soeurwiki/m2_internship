---
title: "QC & Markers of clusters for one sample [Normalized]"
author: "ATIA Safiya"
date: "2023-07-26"
params:
  samp: "samp"
  res: "res"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: lumen
---

# Seurat object  
## Load required packages
```{r,  message=FALSE, warning=FALSE}
library(Seurat)
library(tidyverse)
library(ggplot2)
```

## Load seurat object (NORM)
```{r}
samp <- params$samp
```

```{r}
seurat_obj <- readRDS(file = paste0("./Lucille/results/rds/samples/", samp, "_FindNeighbors.rds"))

seurat_obj
table(seurat_obj$orig.ident)
```

## <span style="color:#296d98;"> Parameters </span>  
```{r}
res = as.double(params$res)
res
```

# Defining cell clusters  
## Optimize resolution  
```{r, message=FALSE}
seurat_obj <- FindClusters(seurat_obj, resolution = res)
levels(seurat_obj[["seurat_clusters"]][[1]])
```

## Plot clusters
```{r}
DimPlot(seurat_obj, reduction = "pca", label = TRUE, group.by = "seurat_clusters") + ggtitle("PC1 vs PC2 with Clusters")
```

```{r}
DimPlot(seurat_obj, reduction = "umap", group.by = "seurat_clusters")
DimPlot(seurat_obj, reduction = "umap", group.by = "seurat_clusters", label.size = 4, label = TRUE)+ NoLegend()
```

```{r}
DimPlot(seurat_obj, reduction = "tsne", group.by = "seurat_clusters")
DimPlot(seurat_obj, reduction = "tsne", group.by = "seurat_clusters", label.size = 4, label = TRUE)+ NoLegend()
```

## QC metrics  
Now that we have our clusters, we can look to see if they are being influenced by any of the QC metrics.  

### Nb of reads  
```{r, message=FALSE}
VlnPlot(seurat_obj, features="nCount_RNA", group.by = "seurat_clusters", pt.size = 0)
RidgePlot(seurat_obj, features = "nCount_RNA", group.by = "seurat_clusters")
```

### Nb of genes    
```{r, message=FALSE}
VlnPlot(seurat_obj, features="nFeature_RNA", group.by = "seurat_clusters", pt.size = 0)
RidgePlot(seurat_obj, features = "nFeature_RNA", group.by = "seurat_clusters")
```

### MT genes  
```{r, message=FALSE}
VlnPlot(seurat_obj, features = "percent.mt", group.by = "seurat_clusters", pt.size = 0)
RidgePlot(seurat_obj, features = "percent.mt", group.by = "seurat_clusters")
```

### Ribosomal genes  
```{r, message=FALSE}
VlnPlot(seurat_obj, features = "percent.ribosomal", group.by = "seurat_clusters", pt.size = 0)
RidgePlot(seurat_obj, features = "percent.ribosomal", group.by = "seurat_clusters")
```

### Largest gene  
```{r, message=FALSE}
VlnPlot(seurat_obj, features = "percent.largest_gene", group.by = "seurat_clusters", pt.size = 0)
RidgePlot(seurat_obj, features = "percent.largest_gene", group.by = "seurat_clusters")
```

```{r}
# which largest gene
seurat_obj[[]] %>%
  group_by(seurat_clusters, largest_gene) %>%
  count() %>%
  arrange(desc(n)) %>%
  group_by(seurat_clusters) %>%
  slice(1:2) %>%
  ungroup() %>%
  arrange(seurat_clusters, desc(n))
```

### Cell cycle  
```{r}
seurat_obj@meta.data %>%
  group_by(seurat_clusters,Phase) %>%
  count() %>%
  group_by(seurat_clusters) %>%
  mutate(percent=100*n/sum(n)) %>%
  ungroup() %>%
  ggplot(aes(x=seurat_clusters,y=percent, fill=Phase)) +
  scale_fill_manual( values=c(G1='azure4',G2M='dodgerblue',S='tomato3' )) +
  geom_col() +
  ggtitle("Percentage of cell cycle phases per sample")
```

```{r}
tibble(
  cluster = seurat_obj$seurat_clusters,
  Phase = seurat_obj$Phase,
) %>%
  group_by(cluster,Phase) %>%
  count() %>%
  group_by(cluster) %>%
  mutate(
    percent=(100*n)/sum(n)
  ) %>%
  ungroup() %>%
  mutate(
    cluster=paste("Cluster",cluster)
  ) %>%
  ggplot(aes(x="",y=percent, fill=Phase)) +
  scale_fill_manual( values=c(G1='azure4',G2M='dodgerblue',S='tomato3' )) +
  geom_col(width=1) +
  coord_polar("y", start=0) +
  facet_wrap(vars(cluster)) +  
  theme(axis.text.x=element_blank()) +
  xlab(NULL) +
  ylab(NULL)
```

### Orig ident
```{r}
tibble(
  cluster = seurat_obj$seurat_clusters,
  orig = seurat_obj$orig.ident,
) %>%
  group_by(cluster,orig) %>%
  count() %>%
  group_by(cluster) %>%
  mutate(
    percent=(100*n)/sum(n)
  ) %>%
  ungroup() %>%
  mutate(
    cluster=paste("Cluster",cluster)
  ) %>%
  ggplot(aes(x="",y=percent, fill=orig)) +
  geom_col(width=1) +
  coord_polar("y", start=0) +
  facet_wrap(vars(cluster)) +  
  theme(axis.text.x=element_blank()) +
  xlab(NULL) +
  ylab(NULL)
```

# Finding markers for each cluster  
Identify genes whose expression defines each cluster which has been identified.

* **The Wilcox rank sum test**: This identifies genes which are differentially regulated between two groups of cells. It is a non-parametric test which makes very few assumptions about the behaviour of the data and just looks for genes which have expression which is consistently ranked more highly in one group of cells compared to another.  

* **The ROC test**: This is a measure of how specifically a gene can predict membership of two groups. It gives a value between 0.5 (no predictive value) and 1 (perfectly predictive on its own) to say how useful each gene is at predicting. Again this is a non-parametric test which just cares about the ranked expression measures for each gene.


## Biomarkers  
### Clusters markers  

```{r, warning=FALSE, message=FALSE}
cluster.markers <- FindAllMarkers(seurat_obj, assay = "SCT", verbose=FALSE)
```

* `DoHeatmap` generates an expression heatmap for given cells and features. In this case, we are plotting the top 20 markers (or all markers if less than 20) for each cluster.   
```{r}
cluster.markers %>%
    group_by(cluster) %>%
    top_n(n = 10, wt = avg_log2FC) -> top10
DoHeatmap(seurat_obj, features = top10$gene) + NoLegend()
```

### Save markers lists
```{r}
saveRDS(cluster.markers, file = paste0( "./Lucille/results/html/",samp, "/", samp, "_cluster.markers.rds"))
```

# Save seurat object  
```{r}
saveRDS(seurat_obj, file = paste0("./Lucille/results/rds/samples/", samp, "_Markers.rds"))
```
